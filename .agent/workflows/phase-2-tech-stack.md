---
description: Phase 2 技術選定 - 要件に基づいて最適な技術スタックを決定する
---

# Phase 2: 技術選定ワークフロー

## 目的・概要

このフェーズでは、Phase 1 で確定した要件に基づいて最適な技術スタックを選定し、`docs/tech-stack.md` として文書化する。

**重要**: 個人開発・無料枠優先の前提を常に意識する。

---

## 担当者

| 役割 | 担当 |
|------|------|
| 主導 | AG（建築家） |
| 承認 | User（施主） |

---

## 前提条件

- [ ] Phase 1 が完了していること
- [ ] `docs/requirements.md` が存在すること
- [ ] `PRODUCT.md` の Current Phase が Phase 2 であること

---

## 対話フロー（段階的提案方式）

### Round 1: 要件→技術のマッピング

`docs/requirements.md` を読み込み、**技術選定に影響する要件**を抽出する：

#### 1.1 機能要件からの導出

| 要件 | 技術への影響 |
|------|---------------|
| リアルタイム機能が必要 | WebSocket対応のバックエンド |
| 画像アップロードが必要 | ストレージサービスの選定 |
| 複雑な検索が必要 | 全文検索対応 DB or Algolia等 |
| スケジュール実行が必要 | Cron/ジョブキュー対応 |

#### 1.2 非機能要件からの導出

`requirements.md` の非機能要件表を確認し、技術選定に反映：

| 非機能要件 | 決定内容 | 技術への影響 |
|------------|---------|---------------|
| SEO | 本格対応 | SSR/SSG必須 → Next.js, Nuxt等 |
| SEO | 不要 | SPA(CSR)でOK → Vite + React等 |
| 認証方式 | 認証サービス利用 | Firebase Auth, Clerk, Auth0等 |
| 認証方式 | SNSログイン | OAuth対応のライブラリ/サービス |
| 通知 | メール | SendGrid, Resend等 |
| 通知 | プッシュ | FCM, OneSignal等 |
| エラー監視 | Sentry等 | Sentry, LogRocket等 |
| アクセス解析 | GA4 | Google Analytics導入 |
| アクセス解析 | プライバシー重視 | Plausible, Umami等 |
| デバイス対応 | モバイルファースト | モバイル対応のUIライブラリ |
| 多言語 | 初期対応 | i18nライブラリ導入 |
| オフライン | PWA | Service Worker対応の構成 |

#### 1.3 制約条件の確認

- 予算：無料枚で始められるか
- 期間：学習コストを含めて現実的か
- 技術制約：ユーザーが指定した技術があるか

> ユーザーに「要件を確認しました。以下の要件が技術選定に影響します」と報告

---

### Round 2: カテゴリ別の技術提案

以下のカテゴリごとに **2〜3の選択肢** を提示：

---

#### 2.1 フロントエンド

| 選択肢 | メリット | デメリット | 推奨度 |
|--------|---------|-----------|--------|
| 例: Next.js | SSR対応、エコシステム | 学習コスト | ★★★ |

---

#### 2.2 バックエンド

| 選択肢 | メリット | デメリット | 推奨度 |
|--------|---------|-----------|--------|
| 例: Next.js API Routes | フロントと一体化 | 複雑な処理には不向き | ★★☆ |

---

#### 2.3 データベース

| 選択肢 | メリット | デメリット | 推奨度 |
|--------|---------|-----------|--------|
| 例: Supabase | PostgreSQL + 認証一体 | ベンダーロックイン | ★★★ |

---

#### 2.4 インフラ・ホスティング

| 選択肢 | メリット | デメリット | 推奨度 |
|--------|---------|-----------|--------|
| 例: Vercel | Next.jsとの親和性 | 無料枚制限 | ★★★ |

---

#### 2.5 認証サービス（認証が必要な場合）

| 選択肢 | メリット | デメリット | 推奨度 |
|--------|---------|-----------|--------|
| Firebase Auth | 無料枚広い、実績豊富 | Google依存 | ★★☆ |
| Clerk | DXが良い、コンポーネント提供 | 無料枚5000MAU | ★★★ |
| Supabase Auth | DBと一体 | 単体だと機能限定 | ★★☆ |

---

#### 2.6 メール送信（通知が必要な場合）

| 選択肢 | メリット | デメリット | 推奨度 |
|--------|---------|-----------|--------|
| Resend | DXが良い、React Email | 新しい | ★★★ |
| SendGrid | 実績豊富、無料枚あり | UIが古い | ★★☆ |

---

#### 2.7 ストレージ（ファイルアップロードが必要な場合）

| 選択肢 | メリット | デメリット | 推奨度 |
|--------|---------|-----------|--------|
| Supabase Storage | DBと一体 | 容量制限 | ★★☆ |
| Cloudflare R2 | 無料枚広い | 設定が少し手間 | ★★★ |

---

#### 2.8 エラー監視（必要な場合）

| 選択肢 | メリット | デメリット | 推奨度 |
|--------|---------|-----------|--------|
| Sentry | デファクトスタンダード | 無料枚制限あり | ★★★ |

---

#### 2.9 アクセス解析（必要な場合）

| 選択肢 | メリット | デメリット | 推奨度 |
|--------|---------|-----------|--------|
| GA4 | 無料、高機能 | Cookie同意必要 | ★★☆ |
| Plausible | プライバシー重視 | 有料($9/月〜) | ★★☆ |
| Umami | セルフホスト可 | 運用コスト | ★★☆ |

---

### Round 3: ユーザーとの合意形成

各カテゴリについてユーザーの意向を確認：

> 「フロントエンドは Next.js を推奨しますが、いかがですか？」
> 「他に気になる技術や、避けたい技術はありますか？」

---

### Round 4: 最終確認

選定した技術スタック全体を提示し、最終確認：

> 「以下の構成で進めてよいですか？」

---

## AGからの提案ルール

### 提案時の考慮事項

1. **個人開発に適しているか**
   - 学習コストは妥当か
   - 一人で運用できるか

2. **コスト意識**
   - 無料枠で始められるか
   - スケール時のコスト見通し

3. **将来性**
   - メンテナンスされているか
   - コミュニティの活発さ

### ⚠️ 避けるべき提案

- 過度に複雑なアーキテクチャ
- 学習コストが高すぎる技術
- 有料プラン前提の構成

---

## 成果物

| ファイル | 説明 |
|---------|------|
| `docs/tech-stack.md` | 技術選定書（このフェーズの最終成果物） |

### tech-stack.md 必須セクション

以下のセクションを必ず含めること：

```markdown
# 技術選定書

## 1. 選定の前提

### 要件からの導出

| 要件 | 技術への影響 | 対応 |
|------|---------------|------|
| 例: SEO本格対応 | SSR/SSG必須 | Next.jsを採用 |
| 例: 認証サービス利用 | 外部認証導入 | Clerkを採用 |

### 制約条件

- 予算：無料枚優先
- 期間：{XX週間}
- 技術制約：{あれば記載}

## 2. コア技術スタック

| カテゴリ | 技術 | 選定理由 |
|---------|------|----------|
| フロントエンド | {Next.js} | {SEO対応、エコシステム} |
| バックエンド | {API Routes} | {フロントと一体化} |
| データベース | {Supabase} | {無料枚充実、PostgreSQL} |
| インフラ | {Vercel} | {Next.jsとの親和性} |

## 3. 補助サービス（必要なもののみ）

| 用途 | 技術 | 選定理由 | 無料枚 |
|------|------|----------|--------|
| 認証 | {Clerk} | {DXが良い} | 5000MAU |
| メール | {Resend} | {React Email対応} | 100通/日 |
| ストレージ | {Supabase Storage} | {DBと一体} | 1GB |
| エラー監視 | {Sentry} | {デファクト} | 5Kイベント/月 |
| 解析 | {不要 or GA4} | {-} | - |

## 4. 開発ツール

| 用途 | ツール |
|------|--------|
| パッケージマネージャ | {pnpm} |
| リンター/フォーマッタ | {ESLint + Prettier} |
| テスト | {Vitest + Playwright} |
| CI/CD | {GitHub Actions} |

## 5. 採用しなかった技術と理由

| 技術 | 不採用の理由 |
|------|---------------|
| 例: Prisma | Drizzleの方が軽量 |
| 例: AWS | 個人開発には複雑 |

## 6. リスクと対策

| リスク | 対策 |
|--------|------|
| 例: Vercel無料枚制限 | 制限超過時はCloudflare Pagesに移行 |
| 例: ベンダーロックイン | DB層を抽象化しておく |
```

## CCレビュー（Claude Code による検証）

成果物作成後、Claude Code でレビューを実施する。

### 実行コマンド

```bash
claude -p "以下のファイルをレビューしてください。
対象: docs/tech-stack.md

レビュー観点:
1. 誤字脱字がないか
2. リスクがないか（技術選定のリスク含む）
3. 記載内容に不備がないか（漏れている情報がないか）
4. 技術的にあり得ないことを言っていないか
5. 職人としての目線で見て、全体的に問題がないドキュメントになっているか

問題があれば具体的に指摘してください。"
```

### レビュー結果の扱い

> ⚠️ **CCの指摘を鵜呑みにしないこと**
> Claude Code も AI なので、必ずしも正しい指摘とは限らない。

1. CCからの指摘を受け取る
2. **AGが指摘の妥当性を検証**する
   - 本当に問題か？
   - 修正が必要か？
   - 過剰な指摘ではないか？
3. 妥当な指摘のみ修正を実施
4. 判断に迷う場合はユーザーに相談

---

## 完了条件

### 必須条件
- [ ] `docs/tech-stack.md` が作成されている
- [ ] コア技術（フロント/バック/DB/インフラ）が選定されている
- [ ] CCレビューが完了している
- [ ] ユーザーが技術選定書を承認している

### 追加確認
- [ ] 非機能要件（認証、通知、監視等）に対応する技術が選定済み
- [ ] 要件→技術のマッピングが明確
- [ ] リスクと対策が考慮されている

---

## 次フェーズへの移行

1. `PRODUCT.md` の `Current Phase` を「Phase 3: ガイドライン策定」に更新
2. `PRODUCT.md` の `Core Tech Stack` テーブルを更新
3. `Status & Decisions` に技術選定完了を記録
4. **README.md の更新**（下記参照）
5. Phase 3 ワークフロー（`/phase-3-guidelines`）を開始

---

## README.md の更新

Phase 2 完了時に `README.md` の技術スタックセクションを更新する。

### 更新対象

```markdown
## 技術スタック

> ⚠️ このセクションは Phase 2（技術選定）完了後に更新されます
```

↓ 以下のように置き換える：

### 更新内容

`docs/tech-stack.md` から主要な技術を抽出し、README.md に反映：

```markdown
## 技術スタック

| カテゴリ | 技術 |
|---------|------|
| フロントエンド | {選定技術} |
| バックエンド | {選定技術} |
| データベース | {選定技術} |
| インフラ | {選定技術} |
```

### 例

```markdown
## 技術スタック

| カテゴリ | 技術 |
|---------|------|
| フロントエンド | Next.js 14 (App Router) |
| バックエンド | Next.js API Routes |
| データベース | Supabase (PostgreSQL) |
| インフラ | Vercel |
```

---
description: Phase 4.1 データ設計 - DB/ファイル/キャッシュ等のデータ構造設計
---

# Phase 4.1: データ設計ワークフロー

## 目的・概要

このフェーズでは、基本設計書に基づいて**データ設計書**を作成する。DB、ファイル、キャッシュ等のデータ構造全般を設計する。

---

## 担当者

| 役割 | 担当 |
|------|------|
| 主導 | AG（建築家） |
| 承認 | User（施主） |

---

## 前提条件

- [ ] Phase 4.0 が完了していること
- [ ] `docs/design/basic-design.md` が存在すること
- [ ] 基本設計でデータ設計が「必要」と判定されていること
- [ ] `PRODUCT.md` の Current Phase が Phase 4.1 であること

> **スキップ条件**: 基本設計でデータ設計が「不要」と判定された場合、このフェーズをスキップして次へ進む。

---

## Step 1: 基本設計の確認

以下を確認し、データ設計の要件を把握する：

1. `docs/design/basic-design.md` - システム概要、データフロー
2. `docs/requirements.md` - データに関する要件
3. `docs/tech-stack.md` - 採用するDB技術

---

## Step 2: ユーザーとの対話

以下の観点でユーザーと対話しながらデータ設計を固める：

### 2.1 エンティティの洗い出し

- どのようなデータを扱うか
- エンティティ間の関係性

### 2.2 各テーブル/コレクションの設計

- カラム/フィールド定義
- 型、制約、デフォルト値
- インデックス
- 外部キー・リレーション

### 2.3 特殊なデータ処理

- 論理削除 vs 物理削除
- 履歴管理（変更履歴の保持）
- キャッシュ戦略

---

## Step 3: Implementation Plan 作成

設計内容が固まったら、実装計画を作成してユーザー承認を得る。

```markdown
# Ph4.1 データ設計 - 実装計画

## 設計概要
（対話で固まった内容のサマリー）

## テーブル/コレクション一覧

| テーブル名 | 説明 | 主要カラム |
|-----------|------|-----------|
| users | ユーザー情報 | id, name, email |
| ... | ... | ... |

## 出力ファイル構成

- `docs/design/db/index.md` - テーブル一覧、ER図
- `docs/design/db/[table].md` - 各テーブル詳細
```

---

## Step 4: データ設計書の作成

ユーザー承認後、以下のファイルを作成する：

### 4.1 `docs/design/db/index.md`

```markdown
# データベース設計

## テーブル一覧

| テーブル | 説明 | 詳細 |
|---------|------|------|
| users | ユーザー情報 | [users.md](./users.md) |
| ... | ... | ... |

## ER図

（Mermaid erDiagram）

## 命名規則

- テーブル名: スネークケース、複数形
- カラム名: スネークケース
- 外部キー: `[参照テーブル単数形]_id`
```

### 4.2 `docs/design/db/[table].md`

各テーブルの詳細設計：

```markdown
# [テーブル名] テーブル

## 概要
このテーブルの目的

## 関連
- API: [関連APIへのリンク]
- 画面: [関連画面へのリンク]

## カラム定義

| カラム | 型 | NULL | 制約 | デフォルト | 説明 |
|--------|-----|------|------|-----------|------|
| id | UUID | NO | PK | gen_random_uuid() | 主キー |
| name | VARCHAR(100) | NO | - | - | 名前 |
| created_at | TIMESTAMP | NO | - | NOW() | 作成日時 |
| updated_at | TIMESTAMP | NO | - | NOW() | 更新日時 |
| deleted_at | TIMESTAMP | YES | - | NULL | 論理削除日時 |

## インデックス

| 名前 | カラム | 種類 | 目的 |
|------|--------|------|------|
| idx_name | name | BTREE | 名前検索の高速化 |

## リレーション

| 対象テーブル | 関係 | 外部キー | 説明 |
|-------------|------|---------|------|
| orders | 1:N | user_id | このユーザーの注文 |
```

---

## Step 5: CCレビュー

データ設計書完成後、Claude Code にレビューを依頼する。

```bash
claude -p "以下のファイルをレビューしてください。
対象: docs/design/db/

レビュー観点:
1. 誤字脱字がないか
2. カラム定義に漏れがないか
3. インデックス設計が適切か
4. リレーションの整合性があるか
5. 基本設計書との乖離がないか
6. 要件定義書（docs/requirements.md）との乖離がないか

問題があれば具体的に指摘してください。"
```

---

## 完了条件

- [ ] `docs/design/db/index.md` が作成されている
- [ ] 全テーブルの詳細ファイル `[table].md` が作成されている
- [ ] ER図が記載されている
- [ ] CCレビューが完了している
- [ ] ユーザーがデータ設計書を承認している
- [ ] `docs/design/index.md` が更新されている

---

## 次フェーズへの移行

1. `PRODUCT.md` の `Current Phase` を次のフェーズに更新
   - API設計が必要 → 「Phase 4.2: API設計」
   - API設計不要で画面設計が必要 → 「Phase 4.3: 画面設計」
2. `Status & Decisions` にデータ設計完了を記録
3. 次のワークフローを開始
